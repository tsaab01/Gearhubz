<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Converter - Tools Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... your existing CSS styles remain the same ... */
    </style>
</head>
<body>
    <!-- ... your existing HTML structure remains the same ... -->

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const formatInfo = document.getElementById('formatInfo');
        const sizeInfo = document.getElementById('sizeInfo');
        const dimensionsInfo = document.getElementById('dimensionsInfo');
        const qualityInfo = document.getElementById('qualityInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const formatButtons = document.querySelectorAll('.format-btn');
        const qualityRange = document.getElementById('qualityRange');
        const qualityValue = document.getElementById('qualityValue');
        const processing = document.getElementById('processing');
        const statusMessage = document.getElementById('statusMessage');

        // Variables
        let currentImage = null;
        let originalFile = null;
        let selectedFormat = 'jpeg';
        let quality = 0.8;

        // Event Listeners
        uploadBtn.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4361ee';
            uploadArea.style.background = 'rgba(67, 97, 238, 0.05)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#e0e0e0';
            uploadArea.style.background = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#e0e0e0';
            uploadArea.style.background = '';
            
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        downloadBtn.addEventListener('click', convertAndDownload);

        formatButtons.forEach(button => {
            button.addEventListener('click', () => {
                formatButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                selectedFormat = button.getAttribute('data-format');
                updateQualityInfo();
                updateDownloadButton();
            });
        });

        qualityRange.addEventListener('input', (e) => {
            quality = e.target.value / 100;
            qualityValue.textContent = e.target.value;
            updateQualityInfo();
            updateDownloadButton();
        });

        // Helper Functions (replacing DownloadHelper)
        function validateFile(file, maxSizeMB = 5) {
            const maxSize = maxSizeMB * 1024 * 1024;
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                return { isValid: false, errors: ['Unsupported file type. Please use JPG, PNG, GIF, or WEBP.'] };
            }
            
            if (file.size > maxSize) {
                return { isValid: false, errors: [`File too large. Maximum size is ${maxSizeMB}MB.`] };
            }
            
            const extension = file.name.split('.').pop().toLowerCase();
            return { 
                isValid: true, 
                fileInfo: { extension } 
            };
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            if (type) {
                statusMessage.classList.add(type);
            }
        }

        // Main Functions
        function handleFile(file) {
            // Reset previous state
            resetState();
            
            // Validate file
            const validation = validateFile(file, 5);
            if (!validation.isValid) {
                showStatus(validation.errors[0], 'error');
                return;
            }

            originalFile = file;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                currentImage = new Image();
                currentImage.onload = function() {
                    // Update preview
                    imagePreview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imagePreview.appendChild(img);
                    
                    // Update file info
                    formatInfo.textContent = validation.fileInfo.extension.toUpperCase();
                    sizeInfo.textContent = formatFileSize(file.size);
                    dimensionsInfo.textContent = `${currentImage.width} Ã— ${currentImage.height}`;
                    updateQualityInfo();
                    
                    // Enable download button
                    updateDownloadButton();
                    showStatus('Image loaded successfully! Select format and click download.', 'success');
                };
                
                currentImage.onerror = function() {
                    showStatus('Error loading image. Please try a different file.', 'error');
                };
                
                currentImage.src = e.target.result;
            };
            
            reader.onerror = function() {
                showStatus('Error reading file. Please try again.', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        function convertAndDownload() {
            if (!currentImage || !originalFile) {
                showStatus('Please upload an image first.', 'error');
                return;
            }

            processing.style.display = 'block';
            downloadBtn.disabled = true;
            showStatus('Processing image...', '');

            try {
                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = currentImage.width;
                canvas.height = currentImage.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(currentImage, 0, 0);

                // Get MIME type for selected format
                let mimeType = 'image/jpeg';
                if (selectedFormat === 'png') {
                    mimeType = 'image/png';
                } else if (selectedFormat === 'webp') {
                    mimeType = 'image/webp';
                }

                // Convert quality for different formats
                let canvasQuality = quality;
                if (selectedFormat === 'png') {
                    canvasQuality = undefined; // PNG is lossless
                }

                // Get data URL from canvas
                let dataURL;
                if (canvasQuality !== undefined) {
                    dataURL = canvas.toDataURL(mimeType, canvasQuality);
                } else {
                    dataURL = canvas.toDataURL(mimeType);
                }

                // Create download link
                const link = document.createElement('a');
                link.download = getConvertedFilename(originalFile.name, selectedFormat);
                link.href = dataURL;
                link.click();

                showStatus(`Successfully downloaded ${link.download}`, 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                processing.style.display = 'none';
                downloadBtn.disabled = false;
            }
        }

        function getConvertedFilename(originalName, targetFormat) {
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            return `${nameWithoutExt}.${targetFormat}`;
        }

        function updateQualityInfo() {
            if (selectedFormat === 'png') {
                qualityInfo.textContent = 'Lossless';
            } else {
                qualityInfo.textContent = `${Math.round(quality * 100)}%`;
            }
        }

        function updateDownloadButton() {
            if (currentImage) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = `Download as ${selectedFormat.toUpperCase()}`;
            } else {
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'Download Converted Image';
            }
        }

        function resetState() {
            currentImage = null;
            originalFile = null;
            downloadBtn.disabled = true;
            processing.style.display = 'none';
            showStatus('', '');
        }
    </script>
</body>
</html>
